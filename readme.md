## Задача 1
Сервис для рассылки уведомлений об истекающих подписках.
За один и за три дня до истечения срока подписки, нужно отправить письмо пользователю с текстом "{username}, your subscription is expiring soon".

### Системные требования
Docker Desktop (Windows, MacOS) или docker-cli и docker-compose (Linux)

### Установка
```bash
  $ git clone https://github.com/Mishasar/karma8.git
```

### Запуск
```bash
  $ bin/run
```

### Описание работы

### Технические требования к продукту
- отправка 80к сообщений в день
- отправка с 6:00 до 12:00
- 148 одновременно работающих воркеров
- не отправлять письма несколько раз

### Описание требований
Так как у нас 5млн пользователей, около 20% пользователей имеют подписки и только 15% пользователей подтверждают свой емейл - активных подписок с подтверждёнными email примерно 1млн (скорее всего большая часть из 15% пользователей находятся в 20% пользователей с подписками, поэтому 5млн * 15%, для простоты округлил вверх).

Подписка длится 1 месяц, пользователи оформляют её примерно равномерно. В таком случае, в день заканчивается 40к подписок (1млн/30дней).

Если email все валидны (а они должны быть валидны все, ведь на них пришло подтверждение и пользователь его подтвердил), нужно отправить 40к + 40к (за 3 и за 1 день) = 80к сообщений в день.
80к сообщений в день отправляются со скоростью 10с (худший случай), значит нужно 800к секунд (примерно 222 часа).

Если все пользователи новые, то каждый email нужно проверять на валидность. (40к * 1мин) / 60 = 666 часов.

В требованиях этого нет, но кажется нет смысла отправлять сообщение вечером, так как подписку скорее всего не продлят. Лучше отправлять её утром, с 6:00 до 12:00.
Значит, у нас есть 6 активных часов. Так как мы имеем 666 + 222 = 888 часа на отправку каждый день, можем посчитать кол-во потоков отправки (кол-во воркеров для очереди) - 148.

### Что нужно реализовать позднее:
- Для достижения отказоустойчивости нужно иметь несколько ДЦ (идеально - 3).
- Метрики и мониторинги
- Полноценные слои и ООП
- Индексы для ускорения поиска (если понадобятся)
- Не проверять адреса confirmed, так как они уже подтверждены

## Задача 2:

```sql
select username
from users
    join (
        select
            o.user_id                                               as user_id,
            if((sum(if(status = 0, 1, 0)) / count(1)) < 0.15, 1, 0) as unsuccessful_payments_condition
        from orders o
        join payments p on o.id = p.order_id
        group by o.user_id
    ) unsuccessful_payments_table on id = unsuccessful_payments_table.user_id
    join (
        select
            o.user_id                                              as user_id,
            if(sum(o.payed) / (count(1) - sum(o.payed)) > 2, 1, 0) as paid_order_condition
        from orders o
        group by o.user_id
    ) paid_order_table on id = paid_order_table.user_id
where unsuccessful_payments_condition = 1 and paid_order_condition = 1;
```

## Задача 3:
![Architecture](docs/img/arch.drawio.svg)
